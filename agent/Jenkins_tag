pipeline {
    agent none
    
    environment {
        AWS_ACCESS_KEY_ID = credentials('AWS_ACCESS_KEY_ID')
        AWS_SECRET_KEY_ID = credentials('AWS_ACCESS_KEY_ID')
        AWS_DEFAULT_REGION = 'ap-south-1'
        EMAIL_RECIPIENTS = 'siddeshsiddu064@gmail.com'
        MISSING_OWNER_INSTANCES_IDS = ''
    }
    
    stages {
        stage('Find Instance IDs Without Tag Owner') {
            agent {
                label 'Slave_1'
            }
            steps {
                script {
                  sh '''
                    MISSING_OWNER_INSTANCES_IDS="$(aws ec2 describe-instances   --output text   --query 'Reservations[].Instances[?!not_null(Tags[?Key == `owner`].Value)] | [].[InstanceId]')"
                      if [[ -z ${env.MISSING_OWNER_INSTANCES_IDS} ]]; then
                            echo "All instances have the 'Owner' tag attached."
                      else
                             echo "Instances without the 'Owner' tag:"
                              echo "${env.MISSING_OWNER_INSTANCES_IDS}"
                      fi
                      '''
                    }
                }
            }
        }
        post {
            always {
                agent {
                    label 'Slave_2'
                }
                echo 'Sending emails ...'
                emailext recipientProviders: [[$class: 'DevelopersRecipientProvider'], [$class: 'RequesterRecipientProvider']],
                        subject: "Build ${currentBuild.fullDisplayName} ${currentBuild.result}",
                         body: """ 
                         <p>Instances without the Owner tag.</p>
                         <p>instanceIDs: "${env.MISSING_OWNER_INSTANCES_IDS}"</p>
                          """,
                        to: "${env.EMAIL_RECIPIENTS}"
            }    }        
    }    